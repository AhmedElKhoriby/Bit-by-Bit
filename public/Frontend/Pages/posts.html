<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Posts</title>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <link rel="stylesheet" href="../Styles/Dashboard.css" />
    </head>
    <body>
        <div id="navbar-container"></div>

        <div class="container mt-4">
            <h2 class="mb-4">All Posts</h2>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Title</th>
                        <th>Content</th>
                        <th>Author</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="postsTableBody"></tbody>
            </table>
        </div>

        <script>
            fetch("partials/nav.html")
                .then((res) => res.text())
                .then(
                    (data) =>
                        (document.getElementById("navbar-container").innerHTML =
                            data)
                );
        </script>
        <script>
            function loadPosts() {
                fetch("http://127.0.0.1:8000/api/articles")
                    .then((res) => res.json())
                    .then((response) => {
                        if (response.success) {
                            const posts = response.data;
                            const postsTableBody =
                                document.getElementById("postsTableBody");
                            postsTableBody.innerHTML = "";

                            posts.forEach((post) => {
                                const row = `
                <tr>
                  <td>${post.id}</td>
                  <td>${post.title}</td>
                  <td>${post.content.substring(0, 50)}...</td>
                  <td>${post.user ? post.user.name : "Unknown"}</td>
                  <td>
                    <button class="btn btn-sm btn-danger" onclick="deletePost(${
                        post.id
                    })">Delete</button>
                  </td>
                </tr>
              `;
                                postsTableBody.innerHTML += row;
                            });
                        } else {
                            alert("Failed to load posts");
                        }
                    })
                    .catch((err) => alert("Error: " + err.message));
            }
            function editPost(postId) {
                window.location.href = `editpost.html?id=${postId}`;
            }

            function deletePost(postId) {
                if (!confirm("Are you sure you want to delete this post?"))
                    return;

                fetch(`http://127.0.0.1:8000/api/articles/${postId}`, {
                    method: "DELETE",
                    headers: { "Content-Type": "application/json" },
                })
                    .then((res) => res.json())
                    .then((response) => {
                        if (response.success) {
                            alert("Post deleted successfully!");
                            loadPosts();
                        } else {
                            alert("Failed to delete post");
                        }
                    })
                    .catch((err) => alert("Error: " + err.message));
            }
            loadPosts();
        </script>
    </body>
</html>
